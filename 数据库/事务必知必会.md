# 事务

### 什么是事务?

* 事务是一组原子性的SQL语句，或者是一个独立的工作单元。事务中的语句，要不全部执行成功，要不全部执行失败。

### 举个实际例子

* 例如我用支付宝转账，主要操作有两个：一个是从我的账户中减去金额，二是对方账户中加上金额，但如果在我减去金额后发生异常，没有在对方账户中加上对应的金额。这时会进行回滚，恢复到一句语句都没有执行的状态

### 事务的4个特征

1. 原子性：事务开始后的所有操作，要么全部做完，要么全部不做。事务执行过程中出错，会回滚到事务开始前的状态，所有的操作就像没有发生一样【这些操作要执行全执行，要不都不执行】
2. 一致性：事务开始前和结束后，数据库的完整性约束没有被破坏【执行前后，总和不变】
3. 隔离性：同一时间，只允许一个事务请求同一数据，不同的事务在并发之间也没有任何干扰
4. 持久性：事务完成后，事务对数据库的所有更新将被保存到数据库，不能回滚

### 并发带来的问题，读脏、不可重复读、幻读。

* 脏读：在事务A修改数据之后提交数据之前，事务B来读取数据，如果不加控制，事务B读取到事务A修改过的数据，而事务A发生异常，进行回滚，此时事务B读到的数据是脏数据。
* 不可重复读：一个事务在读取到某些数据后的某个时间，再次读取之前读过的数据，却发现读出的数据已经发生了变更，或者某些记录已经被删除了
* 幻读：事务A在按查询条件读取某个读取的记录时，事务B又在该范围内插入新的满足条件的记录，当事务A再次按条件查询记录时，会产生新的满足条件的记录

**不可重复读与幻读有什么区别？**

* 不可重复读的重点是修改：在同一事务中，同样的条件，第一次读的数据和第二次读的「数据不一样」。（因为中间有其他事务提交了修改）
* 幻读的重点在于新增或者删除：在同一事务中，同样的条件，第一次和第二次读出来的「记录数不一样」。（因为中间有其他事务提交了插入/删除）
  

### 四个隔离级别？

* 未提交读：所有事务都可以看到其他事务未提交的数据。
  * 导致问题：读脏，不可重复读，幻读。
* 提交读：一个事务只能看到其他已经提交的事务所做的变更
  * 实现：相当于写加锁
  * 导致问题：不可重复读，幻读
* 可重复读：确保统一事务的多个实例在并发读取数据是会看到相同的数据行
  * 实现：读写的时候都加锁
  * 导致问题：幻读
  * 默认隔离级别
* 可串行化：最高的隔离级别，完全串行化读，事务串行执行，读取每一行数据都加锁，会导致大量的超时和锁争用问题
  * 实现：都加锁
  * 导致问题：无