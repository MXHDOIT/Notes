# 网络

**重点知识：**

* 网络分层：OSI七层模型(了解)，TCP/IP四层或五层模型，每一层的代表协议，代表硬件和技术
* 网络传输流程：网络互联(了解)，局域网(了解)，广域网
* 重点协议：
  1. TCP/UDP:掌握特性，原理和流程
  2. HTTP:掌握协议的格式，及作用
  3. 其他重要协议：ARP/RARP , DNS , NAT , NATP , MTU , IMCP ，IP，MAC
  4. 网络传输流程中使用到的技术：以太网，路由，网关+子网掩码

## 基础内容

1. OSI七层模型：物理层，数据链路层，网络层，传输层，会话层，表示层，应用层

2. TCP/IP五层模型：物理层，数据链路层，网络层，传输层，应用层

3. 网络设备：

   1. 集线器：数据转发
   2. 交换机：数据转发，数据链路层
   3. 路由器：网络层
   4. 主机：应用层

   * 了解：交换机和路由器指传统设备，现在网络设备发展比较快，有3,4层交换机，4层路由器

## TCP/IP五层模型（四层模型没有物理层），从下到上

|            | 代表硬件                   | 协议、技术                          | 特性             |
| ---------- | -------------------------- | ----------------------------------- | ---------------- |
| 物理层     | 双绞线，WiFi电磁波，集线器 |                                     | 发送0,1光电信号  |
| 数据链路层 | 交换机                     | 以太网，令牌环网，无线LAN，ARP，MTU |                  |
| 网络层     | 路由器                     | IP                                  |                  |
| 传输层     |                            | TCP/UDP                             | 主机系统内核实现 |
| 应用层     |                            | HTTP,DNS,NAT,NATP,FTP,SMTP          | 应用程序实现     |

* 对于一台主机，它的操作系统内核实现了从传输层到物理层的内容
* 对于一台路由器，它实现了从网络层到物理层
* 对于一台交换机，它实现了数据链路层到物理层
* 对于集线器，只实现了物理层

## 封装和分用

* 封装类似发送快速包裹，需要从内往外打包；分用类似拆快递，需要从外往内拆包。
* 使用程序的时候，就知道目的IP+目的端口号

![image-20200412143327691](E:\GitHub\picBed\img\image-20200412143327691.png)

## 五元组

* 五元组：**"源IP"**+**"源端口号**+**"目的IP"**+**"目的端口号"**+**"协议号"**
* IP：定位网络中某一台主机，在**网络层包装I**P地址。本机IP默认127.0.0.1。长度32位；一般情况下前三位为网络号，最后一位是主机号。
* 端口号：绑定主机中某一个应用程序，应用程序都是通过**在传输层包装**端口号**发生/接收数据**
* IP+端口号：可以定位到网络上具体的某一应用程序
* 发送数据：五元组
* 接收端响应数据：目的IP+目的端口号 = 发送数据包中的源IP+源端口
* MAC地址：
  * MAC地址用来识别数据链路层中相连的节点;
  * 网卡绑定的物理地址
  * 长度为48位, 及6个字节. 一般用16进制数字加上冒号的形式来表示(例如: 08:00:27:03:fb:19)
  * 在网卡出厂时就确定了, 不能修改. mac地址通常是唯一的(虚拟机中的mac地址不是真实的mac地址, 可能会冲突; 也有些网卡支持用户配置mac地址).
* IP和MAC的区别：
  * IP地址描述的是路途总体的起点和终点
  * MAC地址描述的是路途上的每一个区间的起点和终点

## 网络互联（集线器）

* 集线器的作用：只做数据的转发
* ARP协议：建立IP与MAC的映射主机ARP缓存表
* ![image-20200412160531944](E:\GitHub\picBed\img\image-20200412160531944.png)
* 场景：主机A发送FTP”下载某个文件”数据包------>主机C
* 查找目的主机MAC地址：
  1. 查找本地ARP缓存表，通过目的IP查找目的MAC
  2. 如果找到，就直接发送数据包**（广播）**
  3. 如果找不到，主机A广播一个ARP请求数据包---->所有主机接收到ARP数据包
     * ARP请求数据包：源MAC+目的MAC（广播形式的FF:FF：...），目的IP
     * 其他主机接收到ARP数据包的处理过程：
     * if(目的ip==自己的ip) 响应回自己的MAC； else 丢弃数据包
* 冲突域：
  * 概念：连接同一导线上的所有工作站的集合，或者说是同一物理网段上所有节点的集合或以太网上竞争同一宽带的节点集合。（房间中所有人同时说话，会让大家互相都听不清）
  * 集线器网络互联存在冲突域，交换机可以解决冲突域。

## 局域网

* 局域网可以是同网段，可以是不同网段
* 同网段：网百络中同一网段指的是IP地址和子网掩码相与得到相同的网络地址。

#### 交换机连接

* 交换机连接：交换机没有进行数据的加工(封装和分用)
* ![image-20200413135013604](C:\Users\apple\AppData\Roaming\Typora\typora-user-images\image-20200413135013604.png)
  1. 本机封装
  2. 查找本地ARP缓存表，通过目的IP查找目的MAC；
     1. 如果找到，就直接发送数据包
     2. 如果本机ARP缓存表找不到目的MAC-->发送ARP请求的广播数据包--->交换机转发--->类似网络互联的查询IP主机MAC的过程
  3. 发送数据包 --- > 交换机查询目的的MAC --- > 通过MAC地址转换表，知道要发送数据到哪个端口 --- > 通过端口发送对应主机

#### 交换机+路由器

* ![image-20200413135732402](C:\Users\apple\AppData\Roaming\Typora\typora-user-images\image-20200413135732402.png)
* 场景：主机1发送FTP“某文件下载”数据包到主机4
* 发送的数据报：源IP+源MAC+源端口号+目的IP+目的MAC+目的端口号+协议号
* 发送过程：
  1. 判断是否本机与目的主机在同一个网段：目的IP+子网掩码 位与操作得到网络号
     1. 在同一个网段，走交换机连接的逻辑
     2. 在不同网段：通过ARP缓存表，查询网关IP对应的MAC
        1. 主机发送数据报为：**源IP+源MAC+源端口号+目的IP+目的MAC+目的端口号+协议号**
        2. 路由器接受数据报：
           1. 路由器：目的IP对应 设备的 MAC地址 同之前ARP缓存查询的过程相同
           2. 数据报的加工(先分用，在重新封装)
              * 数据包的以太网帧(数据链路层)里边包含的源MAC修改为自己(路由器)的MAC，目的MAC修改为目的主机(主机4)的MAC
           3. 按目的MAC发数据报：发送到主机4
           4. 目的主机解析(分用)，响应数据报(封装发送)，和之前发送端的逻辑一样

## 广域网

* ![image-20200413141230328](C:\Users\apple\AppData\Roaming\Typora\typora-user-images\image-20200413141230328.png)

* 场景：主机1请求https://www.baidu.com/  

  * https: 协议号
  * www.baidu.com : 域名

* 传输流程：

  1. 封装数据报：

     ![image-20200413141500218](C:\Users\apple\AppData\Roaming\Typora\typora-user-images\image-20200413141500218.png)

  2. 路由器解析数据报：分用后封装

     1. 数据链路层：源MAC修改为自己(路由器A)，通过目的IP在路由表查询到下一跳设备的MAC地址，将目的MAC修改为下个设备的MAC。（路由表可能不知道目的IP的地址，但是可以知道相连设备那个方向更近）
     2. 网络层：源IP由局域网IP（主机1）改为路由器公网IP，NAT技术转换局域网IP和公网IP
     3. 传输层（路由器虽然只到网络层，但是还内部涵盖到应用层）：源端口号由局域网端口(主机1程序)改为路由器映射端口；NAPT建立ip+port的局域网主机IP+主机程序端口映射为路由器公网ip+路由器公网端口

## 补充：

1. 三块专用IP地址块：
   1. 专用IP地址块：仅在机构内部使用的IP地址，可以由本机构自行分配，而不需要向互联网的管理机构申请
      * 在互联网中所有路由器，对目的地址是专用地址的数据报一律不进行转发。
   2. 全球地址：全球唯一的IP地址，必须向互联网的管理机构申请，

![image-20200413152832353](C:\Users\apple\AppData\Roaming\Typora\typora-user-images\image-20200413152832353.png)

